# Random Teacher App

## Описание проекта
Веб-приложение рандомайзер учеников для учителей, построенное на React + TypeScript + Vite.

## Технологический стек
- **Frontend**: React 19.2.0, TypeScript 5.9.3
- **Routing**: React Router DOM 7.11.0
- **Стилизация**: Tailwind CSS 4.1.18
- **Backend**: Firebase 12.7.0 (Firestore + Auth)
- **Image Storage**: Cloudinary (бесплатный план: 25 GB)
- **Build Tool**: Vite 7.2.4
- **UI**: React Hot Toast для уведомлений, Lucide React для иконок

## Структура проекта
```
src/
├── components/     # Переиспользуемые компоненты
├── pages/          # Страницы приложения
├── services/       # Сервисы (Firebase и др.)
├── hooks/          # Custom React hooks
├── context/        # React Context для state management
├── types/          # TypeScript типы и интерфейсы
├── utils/          # Вспомогательные функции
├── config/         # Конфигурация (Firebase и др.)
└── assets/         # Статические файлы
```

## Запуск проекта
```bash
# Установка зависимостей
npm install

# Режим разработки
npm run dev

# Сборка для продакшена
npm run build

# Предпросмотр production build
npm preview

# Линтинг кода
npm run lint
```

## Конфигурация
Проект использует Firebase для бэкенда и Cloudinary для хранения изображений. Настройки находятся в `.env` файле:

- **Firebase**: см. Firebase Console
- **Cloudinary**: см. `CLOUDINARY_SETUP.md` для настройки аккаунта

### Загрузка изображений артефактов
- Поддержка drag & drop, выбор файла, вставка из буфера (Ctrl+V)
- Автоматический ресайз до 600x400px на клиенте (экономия bandwidth)
- Cloudinary transformations для оптимизации отображения
- Lazy loading изображений
- См. `docs/IMAGE_UPLOAD_GUIDE.md` и `docs/THUMBNAIL_OPTIMIZATION.md`

## Основные возможности

### Система классов и журналов
- **Классы** - основные группы учеников (8а, 8б, 8в и т.д.)
- **Общий журнал** - создается автоматически при создании класса, содержит всех учеников класса
- **Дополнительные журналы** - можно создавать для групп (например, "Группа 1", "Группа 2", "Английский продвинутый" и т.д.)
- **Гибкая система** - один ученик может быть в нескольких журналах одновременно
- **Автоматическое создание уроков** - при открытии журнала автоматически создается или открывается урок на сегодня
- **Один урок в день** - для каждого журнала можно создать только один урок в день

### Управление учениками
- Добавление учеников в формате "Фамилия Имя"
- Минимальные данные - только Фамилия и Имя
- Новые ученики автоматически добавляются в общий журнал
- Распределение по дополнительным журналам через настройки класса

### Страницы приложения
- **Главная** - карточки классов с доступными журналами
- **Настройки класса** - управление учениками и журналами
- **Журнал** - левый сайдбар со списком учеников, вкладки для сервисов рандомайзера

### Коллекции Firestore
- `classes` - классы учеников (8а, 8б и т.д.)
- `students` - ученики с минимальными данными (Фамилия, Имя)
- `journals` - журналы класса (общий и дополнительные)
- `journalStudents` - связь между журналами и учениками
- `lessons` - уроки (один урок в день на журнал)
- `attendance` - посещаемость по урокам
- `grades` - оценки по урокам

## Особенности
- Hot Module Replacement (HMR)
- ESLint конфигурация для React + TypeScript
- Строгая типизация с TypeScript
- Современный стек с последними версиями библиотек
- Упрощенная структура данных
- Один урок в день на журнал
- Автоматическое создание общего журнала при создании класса

## Оптимизация производительности
Приложение оптимизировано для работы с Firestore:

### Firestore Persistence (офлайн-кэш)
- Включен `persistentLocalCache` с `persistentMultipleTabManager` в `src/config/firebase.ts`
- Повторные открытия страниц загружаются из IndexedDB мгновенно
- Поддержка нескольких вкладок браузера одновременно

### Параллелизация запросов (JournalPage)
- Загрузка данных журнала разбита на 3 фазы с `Promise.all()`
- Фаза 1: journal + todayLesson параллельно
- Фаза 2: class + studentIds + allLessons параллельно
- Фаза 3: batch load students по ID
- Attendance + grades также загружаются параллельно

### Batch-загрузка данных
- Функция `getDocumentsByIds()` для загрузки множества документов за минимальное количество запросов
- Автоматическое разбиение на батчи по 10 элементов (ограничение Firestore для 'in' запросов)
- Используется в `studentService.getByIds()` для загрузки студентов

### Детерминистические ID (journalStudents)
- `journalService.addStudent()` использует ID формата `${journalId}_${studentId}`
- Позволяет `setDoc` без предварительного чтения (нет N+1)
- `removeStudent()` удаляет напрямую по ID без query

### Централизованная загрузка
- Хук `useAllJournals` загружает журналы для всех классов одновременно
- Предотвращает дублирование запросов на главной странице
- Real-time обновления через `onSnapshot`

### Система кэширования
- In-memory кэш с TTL (5 минут по умолчанию) в `src/utils/cache.ts`
- Кэшируются: students, journals, classes, classrooms, attendance, grades
- Точечная инвалидация кэша (по classId, по lessonId) вместо полного сброса
- Pattern-based очистка только для `students:ids:` (составные ключи)

### Табы без перемонтирования
- Вкладки журнала (Рандомайзер, Рассадка, Группы, Все оценки) используют `display: none` вместо условного рендеринга
- Компоненты остаются в DOM при переключении — данные не теряются
- `dataLoadedRef` в GradesTab и SeatingTab предотвращает повторную загрузку

### Пагинация в GradesTab
- Загружаются только последние 15 уроков (вместо всех)
- Кнопка "Загрузить ещё" для подгрузки старых уроков порциями
- Константа `LESSONS_PER_PAGE = 15`

### useSessionState — debounced persistence
- Хук `useSessionState` сохраняет в sessionStorage через debounce (500ms по умолчанию)
- Гарантированное сохранение при unmount через ref
- Используется через `useTabState` для состояния вкладок (Randomizer, Seating, Groups)

### Функциональные обновления Map
- `handleGradeChange` в JournalPage использует `setGradeInputs(prev => ...)` вместо мутации текущего Map
- Предотвращает нестабильное поведение при быстром вводе
